"""
GRVT äº¤æ˜“æœºå™¨äººæ ¸å¿ƒåŠŸèƒ½ç±»
åŒ…å«æ‰€æœ‰äº¤æ˜“ç›¸å…³çš„åŠŸèƒ½å‡½æ•°
"""

import asyncio
from typing import Optional,Tuple
from playwright.async_api import Page, TimeoutError as PlaywrightTimeoutError, expect


class GrvtTradingBot:
    def __init__(self, page: Page):
        self.page = page
        self.timeout = 10000  # 10ç§’è¶…æ—¶

    # ==================== ä»·æ ¼è·å–ç›¸å…³ ====================

    async def get_orderbook_bid_price(self, max_attempts: int = 3) -> Optional[float]:
        """
        ä»è®¢å•ç°¿è·å–æœ€é«˜ä¹°ä»·ï¼ˆBidï¼‰- ç»¿è‰²ä»·æ ¼

        Args:
            max_attempts: æœ€å¤§å°è¯•æ¬¡æ•°

        Returns:
            float: æœ€é«˜ä¹°ä»·ï¼Œå¦‚æœè·å–å¤±è´¥è¿”å› None
        """
        for attempt in range(max_attempts):
            try:
                print(f"ä»è®¢å•ç°¿è·å–ä¹°ä»· (ç¬¬ {attempt + 1}/{max_attempts} æ¬¡)...")

                # ç­‰å¾…ç»¿è‰²ä»·æ ¼å…ƒç´ 
                await self.page.wait_for_selector(
                    '.txt-feature-green',
                    state="visible",
                    timeout=10000
                )

                await asyncio.sleep(0.5)

                # è·å–æ‰€æœ‰å¯è§çš„ç»¿è‰²ä»·æ ¼ï¼ˆä¹°å•ï¼‰
                # æ’é™¤éšè—å…ƒç´ ï¼ˆclass åŒ…å« d-noneï¼‰
                bid_rows = self.page.locator(
                    'div.style_row__q_Oum:not(.d-none) .txt-feature-green'
                ).first

                if await bid_rows.count() > 0:
                    price_text = await bid_rows.text_content()
                    price_text = price_text.strip().replace(',', '')

                    if price_text and price_text != '-':
                        price = float(price_text)
                        if 0 < price < 10000000:
                            print(f"âœ“ æœ€é«˜ä¹°ä»· (Bid): {price}")
                            return price

                print("  æœªæ‰¾åˆ°æœ‰æ•ˆä¹°ä»·ï¼Œé‡è¯•...")
                await asyncio.sleep(1)

            except Exception as e:
                print(f"  è·å–ä¹°ä»·å‡ºé”™: {e}")
                if attempt < max_attempts - 1:
                    await asyncio.sleep(1)

        print(f"âœ— è·å–ä¹°ä»·å¤±è´¥")
        return None

    async def get_orderbook_ask_price(self, max_attempts: int = 3) -> Optional[float]:
        """
        ä»è®¢å•ç°¿è·å–æœ€ä½å–ä»·ï¼ˆAskï¼‰- çº¢è‰²ä»·æ ¼

        Args:
            max_attempts: æœ€å¤§å°è¯•æ¬¡æ•°

        Returns:
            float: æœ€ä½å–ä»·ï¼Œå¦‚æœè·å–å¤±è´¥è¿”å› None
        """
        for attempt in range(max_attempts):
            try:
                print(f"ä»è®¢å•ç°¿è·å–å–ä»· (ç¬¬ {attempt + 1}/{max_attempts} æ¬¡)...")

                # ç­‰å¾…çº¢è‰²ä»·æ ¼å…ƒç´ 
                await self.page.wait_for_selector(
                    '.txt-feature-red',
                    state="visible",
                    timeout=10000
                )

                await asyncio.sleep(0.5)

                # è·å–æ‰€æœ‰å¯è§çš„çº¢è‰²ä»·æ ¼ï¼ˆå–å•ï¼‰
                # å–å•ä»ä¸Šåˆ°ä¸‹æ˜¯ä»ä½åˆ°é«˜ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå°±æ˜¯æœ€ä½å–ä»·
                # æ’é™¤éšè—å…ƒç´ ï¼ˆclass åŒ…å« d-noneï¼‰
                ask_rows = self.page.locator(
                    'div.style_row__q_Oum:not(.d-none) .txt-feature-red'
                ).first

                if await ask_rows.count() > 0:
                    price_text = await ask_rows.text_content()
                    price_text = price_text.strip().replace(',', '')

                    if price_text and price_text != '-':
                        price = float(price_text)
                        if 0 < price < 10000000:
                            print(f"âœ“ æœ€ä½å–ä»· (Ask): {price}")
                            return price

                print("  æœªæ‰¾åˆ°æœ‰æ•ˆå–ä»·ï¼Œé‡è¯•...")
                await asyncio.sleep(1)

            except Exception as e:
                print(f"  è·å–å–ä»·å‡ºé”™: {e}")
                if attempt < max_attempts - 1:
                    await asyncio.sleep(1)

        print(f"âœ— è·å–å–ä»·å¤±è´¥")
        return None

    async def get_orderbook_prices(self, max_attempts: int = 3) -> Tuple[Optional[float], Optional[float]]:
        """
        ä»è®¢å•ç°¿è·å–æœ€é«˜ä¹°ä»·å’Œæœ€ä½å–ä»·

        Args:
            max_attempts: æœ€å¤§å°è¯•æ¬¡æ•°

        Returns:
            Tuple[Optional[float], Optional[float]]: (æœ€é«˜ä¹°ä»·, æœ€ä½å–ä»·)
        """
        for attempt in range(max_attempts):
            try:
                print(f"å°è¯•ä»è®¢å•ç°¿è·å–ä»·æ ¼ (ç¬¬ {attempt + 1}/{max_attempts} æ¬¡)...")

                # ç­‰å¾…è®¢å•ç°¿åŠ è½½
                await self.page.wait_for_selector(
                    '.txt-feature-green, .txt-feature-red',
                    state="visible",
                    timeout=10000
                )

                await asyncio.sleep(1)

                # è·å–æœ€ä½å–ä»·ï¼ˆçº¢è‰²ï¼Œå¯è§çš„ç¬¬ä¸€ä¸ªï¼‰
                ask_price = None
                ask_elements = self.page.locator('.txt-feature-red').filter(
                    has_not=self.page.locator('.d-none')
                )

                ask_count = await ask_elements.count()
                print(f"  æ‰¾åˆ° {ask_count} ä¸ªå¯è§å–å•")

                for i in range(min(ask_count, 5)):  # æ£€æŸ¥å‰5ä¸ª
                    try:
                        element = ask_elements.nth(i)
                        # ç¡®ä¿å…ƒç´ å¯è§
                        if await element.is_visible():
                            price_text = await element.text_content()
                            price_text = price_text.strip().replace(',', '')

                            # éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆä»·æ ¼
                            if price_text and price_text != '-':
                                price = float(price_text)
                                if 0 < price < 10000000:
                                    ask_price = price
                                    print(f"âœ“ æœ€ä½å–ä»· (Ask): {ask_price}")
                                    break
                    except:
                        continue

                # è·å–æœ€é«˜ä¹°ä»·ï¼ˆç»¿è‰²ï¼Œå¯è§çš„ç¬¬ä¸€ä¸ªï¼‰
                bid_price = None
                bid_elements = self.page.locator('.txt-feature-green').filter(
                    has_not=self.page.locator('.d-none')
                )

                bid_count = await bid_elements.count()
                print(f"  æ‰¾åˆ° {bid_count} ä¸ªå¯è§ä¹°å•")

                for i in range(min(bid_count, 5)):  # æ£€æŸ¥å‰5ä¸ª
                    try:
                        element = bid_elements.nth(i)
                        # ç¡®ä¿å…ƒç´ å¯è§
                        if await element.is_visible():
                            price_text = await element.text_content()
                            price_text = price_text.strip().replace(',', '')

                            # éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆä»·æ ¼
                            if price_text and price_text != '-':
                                price = float(price_text)
                                if 0 < price < 10000000:
                                    bid_price = price
                                    print(f"âœ“ æœ€é«˜ä¹°ä»· (Bid): {bid_price}")
                                    break
                    except:
                        continue

                # å¦‚æœéƒ½è·å–æˆåŠŸï¼Œè¿”å›ç»“æœ
                if bid_price is not None and ask_price is not None:
                    spread = ask_price - bid_price
                    spread_pct = (spread / bid_price) * 100
                    print(f"âœ“ ä»·å·®: {spread:.2f} ({spread_pct:.3f}%)")
                    return bid_price, ask_price

                print("  æœªèƒ½è·å–æœ‰æ•ˆä»·æ ¼ï¼Œé‡è¯•...")
                await asyncio.sleep(1)

            except Exception as e:
                print(f"  è·å–ä»·æ ¼å‡ºé”™: {e}")
                if attempt < max_attempts - 1:
                    await asyncio.sleep(1)

        print(f"âœ— è·å–è®¢å•ç°¿ä»·æ ¼å¤±è´¥")
        return None, None

    def calculate_mid_price(self, highest_bid, lowest_ask):
        """
        è®¡ç®—ä¸­é—´ä»·
        """
        if highest_bid and lowest_ask:
            mid_price = round((highest_bid + lowest_ask) / 2, 1)
            print(f"ä¸­é—´ä»· (Mid): {mid_price}")
            return mid_price
        print("æ— æ³•è®¡ç®—ä¸­é—´ä»·")
        return None

    # ==================== æ æ†è®¾ç½® ====================

    async def get_current_leverage(self):
        """è·å–å½“å‰æ æ†å€æ•°"""
        try:
            # æŸ¥æ‰¾æ˜¾ç¤ºæ æ†çš„å…ƒç´ 
            leverage_display = self.page.locator('span:has-text("Leverage")').locator(
                'xpath=following-sibling::span').first
            leverage_text = await leverage_display.text_content()
            # æå–æ•°å­—ï¼Œä¾‹å¦‚ "10x" -> 10
            leverage = int(leverage_text.replace('x', '').strip())
            print(f"å½“å‰æ æ†: {leverage}x")
            return leverage
        except Exception as e:
            print(f"âŒ è·å–å½“å‰æ æ†å¤±è´¥: {e}")
            return None

    async def set_leverage(self, leverage):
        """
        è®¾ç½®æ æ†å€æ•°
        leverage: ç›®æ ‡æ æ†å€æ•° (1-50)
        """
        print("\n" + "=" * 60)
        print(f"âš™ï¸ è®¾ç½®æ æ†ä¸º {leverage}x")
        print("=" * 60)

        try:
            # 1. ç‚¹å‡» Leverage åŒºåŸŸæ‰“å¼€å¯¹è¯æ¡†
            leverage_button = self.page.locator('span:has-text("Leverage")').locator(
                'xpath=ancestor::span[contains(@class, "text-field_prefix")]')
            await leverage_button.wait_for(state="visible", timeout=self.timeout)
            await leverage_button.click()
            await asyncio.sleep(1)

            # éªŒè¯å¯¹è¯æ¡†æ˜¯å¦æ‰“å¼€
            dialog = self.page.locator('.style_contentWrapper__JrKWn:has-text("Adjust Leverage")')
            if await dialog.count() == 0:
                print("âŒ æœªèƒ½æ‰“å¼€æ æ†è®¾ç½®å¯¹è¯æ¡†")
                return False

            print("âœ“ æ æ†è®¾ç½®å¯¹è¯æ¡†å·²æ‰“å¼€")

            # 2. åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ æ†å€¼
            leverage_input = dialog.locator('input[data-sentry-component="InputLeverage"]')
            await leverage_input.wait_for(state="visible", timeout=self.timeout)

            # æ¸…ç©ºå¹¶è¾“å…¥æ–°å€¼
            await leverage_input.click(click_count=3)  # å…¨é€‰
            await leverage_input.press("Backspace")
            await asyncio.sleep(0.3)
            await leverage_input.fill(f"{leverage}x")
            print(f"âœ“ å·²è¾“å…¥æ æ†å€¼: {leverage}x")
            await asyncio.sleep(0.5)

            # 3. ç‚¹å‡» Confirm æŒ‰é’®
            confirm_button = dialog.locator('button:has-text("Confirm")')
            await confirm_button.click()
            print("âœ“ å·²ç¡®è®¤æ æ†è®¾ç½®")
            await asyncio.sleep(1)

            # 4. éªŒè¯æ˜¯å¦è®¾ç½®æˆåŠŸ
            current_leverage = await self.get_current_leverage()
            if current_leverage == leverage:
                print(f"âœ… æ æ†å·²æˆåŠŸè®¾ç½®ä¸º {leverage}x")
                return True
            else:
                print(f"âš ï¸ æ æ†è®¾ç½®å¯èƒ½æœªæˆåŠŸï¼Œå½“å‰å€¼: {current_leverage}x")
                return False

        except Exception as e:
            print(f"âŒ è®¾ç½®æ æ†æ—¶å‡ºé”™: {e}")
            import traceback
            traceback.print_exc()
            return False

    # ==================== è®¢å•ç±»å‹åˆ‡æ¢ ====================

    async def switch_to_limit_order(self):
        """åˆ‡æ¢åˆ°é™ä»·å•"""
        try:
            # åœ¨å³ä¾§äº¤æ˜“é¢æ¿ä¸­æŸ¥æ‰¾ Limit æ ‡ç­¾ï¼ˆä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼‰
            limit_tab = self.page.locator('[data-sentry-component="TypeTabs"]').locator('text="Limit"').first
            await limit_tab.wait_for(state="visible", timeout=self.timeout)

            # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€
            parent = limit_tab.locator('xpath=..')
            class_name = await parent.get_attribute('class')

            if 'active' not in class_name.lower():
                await limit_tab.click()
                await asyncio.sleep(0.5)
                print("âœ“ å·²åˆ‡æ¢åˆ°é™ä»·å•")
            else:
                print("âœ“ å·²ç»æ˜¯é™ä»·å•æ¨¡å¼")

            return True
        except Exception as e:
            print(f"âŒ åˆ‡æ¢åˆ°é™ä»·å•å¤±è´¥: {e}")
            return False

    async def switch_to_market_order(self):
        """åˆ‡æ¢åˆ°å¸‚ä»·å•"""
        try:
            # åœ¨å³ä¾§äº¤æ˜“é¢æ¿ä¸­æŸ¥æ‰¾ Market æ ‡ç­¾ï¼ˆä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨ï¼‰
            market_tab = self.page.locator('[data-sentry-component="TypeTabs"]').locator('text="Market"').first
            await market_tab.wait_for(state="visible", timeout=self.timeout)

            # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æ¿€æ´»çŠ¶æ€
            parent = market_tab.locator('xpath=..')
            class_name = await parent.get_attribute('class')

            if 'active' not in class_name.lower():
                await market_tab.click()
                await asyncio.sleep(0.5)
                print("âœ“ å·²åˆ‡æ¢åˆ°å¸‚ä»·å•")
            else:
                print("âœ“ å·²ç»æ˜¯å¸‚ä»·å•æ¨¡å¼")

            return True
        except Exception as e:
            print(f"âŒ åˆ‡æ¢åˆ°å¸‚ä»·å•å¤±è´¥: {e}")
            return False

    # ==================== å¡«å†™è®¢å•è¡¨å• ====================

    async def fill_limit_order_form(self, price, quantity=0.002):
        """
        å¡«å†™é™ä»·å•è¡¨å•ï¼ˆä»·æ ¼+æ•°é‡ï¼‰
        """
        try:
            print(f"å¡«å†™é™ä»·å• - ä»·æ ¼: {price}, æ•°é‡: {quantity}")

            # å¡«å†™ä»·æ ¼
            price_input = self.page.locator('input[placeholder="Price"]')
            await price_input.wait_for(state="visible", timeout=self.timeout)
            await price_input.click(click_count=3)
            await price_input.press("Backspace")
            await asyncio.sleep(0.3)
            await price_input.fill(str(price))
            print(f"âœ“ å·²å¡«å…¥ä»·æ ¼: {price}")
            await asyncio.sleep(0.5)

            # å¡«å†™æ•°é‡
            quantity_input = self.page.locator('input[placeholder="Quantity"]')
            await quantity_input.wait_for(state="visible", timeout=self.timeout)
            await quantity_input.click(click_count=3)
            await quantity_input.press("Backspace")
            await asyncio.sleep(0.3)
            await quantity_input.fill(str(quantity))
            print(f"âœ“ å·²å¡«å…¥æ•°é‡: {quantity}")
            await asyncio.sleep(0.5)

            return True

        except Exception as e:
            print(f"âŒ å¡«å†™é™ä»·å•è¡¨å•æ—¶å‡ºé”™: {e}")
            return False

    async def fill_market_order_form(self, quantity=0.002):
        """
        å¡«å†™å¸‚ä»·å•è¡¨å•ï¼ˆåªéœ€è¦æ•°é‡ï¼‰
        """
        try:
            print(f"å¡«å†™å¸‚ä»·å• - æ•°é‡: {quantity}")

            # å¸‚ä»·å•åªéœ€è¦å¡«å†™æ•°é‡
            quantity_input = self.page.locator('input[placeholder="Quantity"]')
            await quantity_input.wait_for(state="visible", timeout=self.timeout)
            await quantity_input.click(click_count=3)
            await quantity_input.press("Backspace")
            await asyncio.sleep(0.3)
            await quantity_input.fill(str(quantity))
            print(f"âœ“ å·²å¡«å…¥æ•°é‡: {quantity}")
            await asyncio.sleep(0.5)

            return True

        except Exception as e:
            print(f"âŒ å¡«å†™å¸‚ä»·å•è¡¨å•æ—¶å‡ºé”™: {e}")
            return False

    # ==================== ç‚¹å‡»ä¸‹å•æŒ‰é’® ====================

    async def click_buy_long(self):
        """ç‚¹å‡» Buy/Long æŒ‰é’®"""
        try:
            print("ç‚¹å‡» Buy/Long æŒ‰é’®...")

            buy_button = self.page.locator('button:has-text("Buy / Long")')
            await buy_button.wait_for(state="visible", timeout=self.timeout)

            await buy_button.click()
            print("âœ“ å·²ç‚¹å‡» Buy/Long æŒ‰é’®")
            await asyncio.sleep(2)

            # æ£€æŸ¥ç¡®è®¤å¼¹çª—
            try:
                confirm_button = self.page.locator('button:has-text("Confirm"), button:has-text("ç¡®è®¤")')
                if await confirm_button.count() > 0:
                    await confirm_button.first.click()
                    print("âœ“ å·²ç¡®è®¤è®¢å•")
                    await asyncio.sleep(1)
            except:
                pass

            return True

        except Exception as e:
            print(f"âŒ ç‚¹å‡»ä¹°å…¥æŒ‰é’®æ—¶å‡ºé”™: {e}")
            return False

    async def click_sell_short(self):
        """ç‚¹å‡» Sell/Short æŒ‰é’®"""
        try:
            print("ç‚¹å‡» Sell/Short æŒ‰é’®...")

            sell_button = self.page.locator('button:has-text("Sell / Short")')
            await sell_button.wait_for(state="visible", timeout=self.timeout)

            await sell_button.click()
            print("âœ“ å·²ç‚¹å‡» Sell/Short æŒ‰é’®")
            await asyncio.sleep(2)

            # æ£€æŸ¥ç¡®è®¤å¼¹çª—
            try:
                confirm_button = self.page.locator('button:has-text("Confirm"), button:has-text("ç¡®è®¤")')
                if await confirm_button.count() > 0:
                    await confirm_button.first.click()
                    print("âœ“ å·²ç¡®è®¤è®¢å•")
                    await asyncio.sleep(1)
            except:
                pass

            return True

        except Exception as e:
            print(f"âŒ ç‚¹å‡»å–å‡ºæŒ‰é’®æ—¶å‡ºé”™: {e}")
            return False

    # ==================== å¸‚ä»·å¼€ä»“ ====================

    async def market_buy_long(self, quantity=0.002):
        """å¸‚ä»·åšå¤š"""
        print("\n" + "=" * 60)
        print("ğŸ“ˆ å¸‚ä»·åšå¤š")
        print("=" * 60)

        # 1. åˆ‡æ¢åˆ°å¸‚ä»·å•
        if not await self.switch_to_market_order():
            return False

        # 2. åªå¡«å†™æ•°é‡ï¼ˆå¸‚ä»·å•ä¸éœ€è¦ä»·æ ¼ï¼‰
        if not await self.fill_market_order_form(quantity):
            return False

        # 3. ç‚¹å‡»ä¹°å…¥
        if not await self.click_buy_long():
            return False

        print("âœ… å¸‚ä»·åšå¤šè®¢å•å·²æäº¤")
        return True

    async def market_sell_short(self, quantity=0.002):
        """å¸‚ä»·åšç©º"""
        print("\n" + "=" * 60)
        print("ğŸ“‰ å¸‚ä»·åšç©º")
        print("=" * 60)

        # 1. åˆ‡æ¢åˆ°å¸‚ä»·å•
        if not await self.switch_to_market_order():
            return False

        # 2. åªå¡«å†™æ•°é‡ï¼ˆå¸‚ä»·å•ä¸éœ€è¦ä»·æ ¼ï¼‰
        if not await self.fill_market_order_form(quantity):
            return False

        # 3. ç‚¹å‡»å–å‡º
        if not await self.click_sell_short():
            return False

        print("âœ… å¸‚ä»·åšç©ºè®¢å•å·²æäº¤")
        return True

    # ==================== é™ä»·å¼€ä»“ ====================

    async def limit_buy_long(self, price=None, quantity=0.002):
        """é™ä»·åšå¤š"""
        print("\n" + "=" * 60)
        print("ğŸ“ˆ é™ä»·åšå¤š")
        print("=" * 60)

        # å¦‚æœæ²¡æœ‰æŒ‡å®šä»·æ ¼ï¼Œä½¿ç”¨ä¸­é—´ä»·
        if price is None:
            bid, ask = await self.get_order_book_prices()
            if bid and ask:
                price = self.calculate_mid_price(bid, ask)
            else:
                print("âŒ æ— æ³•è·å–ä»·æ ¼")
                return False

        # 1. åˆ‡æ¢åˆ°é™ä»·å•
        if not await self.switch_to_limit_order():
            return False

        # 2. å¡«å†™ä»·æ ¼å’Œæ•°é‡
        if not await self.fill_limit_order_form(price, quantity):
            return False

        # 3. ç‚¹å‡»ä¹°å…¥
        if not await self.click_buy_long():
            return False

        print("âœ… é™ä»·åšå¤šè®¢å•å·²æäº¤")
        return True

    async def limit_sell_short(self, price=None, quantity=0.002):
        """é™ä»·åšç©º"""
        print("\n" + "=" * 60)
        print("ğŸ“‰ é™ä»·åšç©º")
        print("=" * 60)

        # å¦‚æœæ²¡æœ‰æŒ‡å®šä»·æ ¼ï¼Œä½¿ç”¨ä¸­é—´ä»·
        if price is None:
            bid, ask = await self.get_order_book_prices()
            if bid and ask:
                price = self.calculate_mid_price(bid, ask)
            else:
                print("âŒ æ— æ³•è·å–ä»·æ ¼")
                return False

        # 1. åˆ‡æ¢åˆ°é™ä»·å•
        if not await self.switch_to_limit_order():
            return False

        # 2. å¡«å†™ä»·æ ¼å’Œæ•°é‡
        if not await self.fill_limit_order_form(price, quantity):
            return False

        # 3. ç‚¹å‡»å–å‡º
        if not await self.click_sell_short():
            return False

        print("âœ… é™ä»·åšç©ºè®¢å•å·²æäº¤")
        return True

    # ==================== æŒä»“æŸ¥è¯¢ ====================

    async def check_positions(self, show_details=True):
        """
        æ£€æŸ¥ Positions æ ‡ç­¾é¡µä¸­æ˜¯å¦æœ‰æŒä»“
        è¿”å›: æŒä»“æ•°é‡
        """
        try:
            if show_details:
                print("æ£€æŸ¥æŒä»“çŠ¶æ€...")

            # ç‚¹å‡» Positions æ ‡ç­¾
            positions_tab = self.page.locator('div:has-text("Positions")').first
            await positions_tab.wait_for(state="visible", timeout=self.timeout)
            await positions_tab.click()
            await asyncio.sleep(2)

            # æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º "No results"
            no_results = self.page.locator('div:has-text("No results")')

            if await no_results.count() > 0:
                if show_details:
                    print("â„¹ï¸ å½“å‰æ²¡æœ‰æŒä»“")
                return 0
            else:
                # è·å–æŒä»“è¡Œ
                position_rows = await self.page.locator(
                    '[data-sentry-component="TablePositions"] .style_tableRow__gbjWO').all()
                position_count = len(position_rows)

                if position_count > 0:
                    if show_details:
                        print(f"âœ“ æŒä»“æ•°é‡: {position_count}")
                        print("\næŒä»“è¯¦æƒ…:")

                        # æ‰“å°æ¯ä¸ªæŒä»“çš„è¯¦ç»†ä¿¡æ¯
                        for i, row in enumerate(position_rows, 1):
                            try:
                                # æå–æŒä»“ä¿¡æ¯
                                cells = await row.locator('[data-sentry-element="CellWrapper"]').all()
                                if len(cells) >= 5:
                                    product = await cells[0].text_content()
                                    quantity = await cells[1].text_content()
                                    value = await cells[2].text_content()
                                    entry_price = await cells[3].text_content()
                                    mark_price = await cells[4].text_content()

                                    print(f"\n  æŒä»“ {i}:")
                                    print(f"    äº§å“: {product.strip()}")
                                    print(f"    æ•°é‡: {quantity.strip()}")
                                    print(f"    ä»·å€¼: {value.strip()}")
                                    print(f"    å…¥åœºä»·: {entry_price.strip()}")
                                    print(f"    æ ‡è®°ä»·: {mark_price.strip()}")
                            except:
                                pass

                    return position_count
                else:
                    if show_details:
                        print("âš ï¸ æœ‰æŒä»“ä½†æ— æ³•å‡†ç¡®è®¡æ•°")
                    return -1

        except Exception as e:
            print(f"âŒ æ£€æŸ¥æŒä»“æ—¶å‡ºé”™: {e}")
            return -1

    async def get_position_list(self):
        """è·å–æŒä»“åˆ—è¡¨ï¼ˆå¸¦è¯¦ç»†ä¿¡æ¯ï¼‰"""
        try:
            # åˆ‡æ¢åˆ° Positions æ ‡ç­¾
            positions_tab = self.page.locator('div:has-text("Positions")').first
            await positions_tab.click()
            await asyncio.sleep(2)

            # è·å–æŒä»“è¡Œ
            position_rows = await self.page.locator(
                '[data-sentry-component="TablePositions"] .style_tableRow__gbjWO').all()

            positions = []
            for row in position_rows:
                try:
                    cells = await row.locator('[data-sentry-element="CellWrapper"]').all()
                    if len(cells) >= 5:
                        position_info = {
                            'product': (await cells[0].text_content()).strip(),
                            'quantity': (await cells[1].text_content()).strip(),
                            'value': (await cells[2].text_content()).strip(),
                            'entry_price': (await cells[3].text_content()).strip(),
                            'mark_price': (await cells[4].text_content()).strip(),
                            'row_element': row
                        }
                        positions.append(position_info)
                except:
                    continue

            return positions

        except Exception as e:
            print(f"âŒ è·å–æŒä»“åˆ—è¡¨æ—¶å‡ºé”™: {e}")
            return []

    # ==================== å¹³ä»“ç›¸å…³ ====================

    async def click_limit_close_button(self, position_row=None):
        """
        ç‚¹å‡»æŒ‡å®šæŒä»“çš„ Limit å¹³ä»“æŒ‰é’®
        å¦‚æœ position_row ä¸º Noneï¼Œåˆ™ç‚¹å‡»ç¬¬ä¸€ä¸ªæŒä»“çš„æŒ‰é’®
        """
        try:
            if position_row:
                limit_button = position_row.locator('button:has-text("Limit")')
            else:
                limit_button = self.page.locator('button:has-text("Limit")').first

            await limit_button.wait_for(state="visible", timeout=self.timeout)
            await limit_button.click()
            await asyncio.sleep(1)

            # éªŒè¯å¯¹è¯æ¡†æ˜¯å¦æ‰“å¼€
            close_dialog = self.page.locator('.style_contentWrapper__JrKWn')
            if await close_dialog.count() > 0:
                print("âœ“ å¹³ä»“å¯¹è¯æ¡†å·²æ‰“å¼€")
                return True
            else:
                print("âš ï¸ æœªæ£€æµ‹åˆ°å¹³ä»“å¯¹è¯æ¡†")
                return False

        except Exception as e:
            print(f"âŒ æ‰“å¼€å¹³ä»“å¯¹è¯æ¡†æ—¶å‡ºé”™: {e}")
            return False

    async def click_market_close_button(self, position_row=None):
        """ç‚¹å‡» Market å¹³ä»“æŒ‰é’®"""
        try:
            if position_row:
                market_button = position_row.locator('button:has-text("Market")')
            else:
                market_button = self.page.locator('button:has-text("Market")').first

            await market_button.wait_for(state="visible", timeout=self.timeout)
            await market_button.click()
            await asyncio.sleep(1)

            # éªŒè¯å¯¹è¯æ¡†æ˜¯å¦æ‰“å¼€
            close_dialog = self.page.locator('.style_contentWrapper__JrKWn')
            if await close_dialog.count() > 0:
                print("âœ“ å¸‚ä»·å¹³ä»“å¯¹è¯æ¡†å·²æ‰“å¼€")
                return True
            else:
                print("âš ï¸ æœªæ£€æµ‹åˆ°å¹³ä»“å¯¹è¯æ¡†")
                return False

        except Exception as e:
            print(f"âŒ æ‰“å¼€å¸‚ä»·å¹³ä»“å¯¹è¯æ¡†æ—¶å‡ºé”™: {e}")
            return False

    async def fill_limit_close_form(self, price):
        """
        å¡«å†™é™ä»·å¹³ä»“è¡¨å•
        """
        try:
            print(f"å¡«å†™é™ä»·å¹³ä»“ä»·æ ¼: {price}")
            await asyncio.sleep(1)

            # å¡«å†™ä»·æ ¼
            order_price_input = self.page.locator('input[placeholder="Enter Order price"]')
            if await order_price_input.count() > 0:
                await order_price_input.click(click_count=3)
                await order_price_input.press("Backspace")
                await asyncio.sleep(0.3)
                await order_price_input.fill(str(price))
                print(f"âœ“ å·²å¡«å…¥å¹³ä»“ä»·æ ¼: {price}")
                await asyncio.sleep(0.5)

            # æ•°é‡å·²è‡ªåŠ¨å¡«å……ï¼Œæ— éœ€ä¿®æ”¹
            return True

        except Exception as e:
            print(f"âŒ å¡«å†™å¹³ä»“è¡¨å•æ—¶å‡ºé”™: {e}")
            return False

    async def confirm_close_position(self):
        """ç‚¹å‡»ç¡®è®¤æŒ‰é’®å…³é—­æŒä»“"""
        try:
            print("ç‚¹å‡»ç¡®è®¤æŒ‰é’®...")

            confirm_button = self.page.locator('.style_contentWrapper__JrKWn button:has-text("Confirm")')
            await confirm_button.wait_for(state="visible", timeout=self.timeout)

            await confirm_button.click()
            print("âœ“ å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®")
            await asyncio.sleep(2)

            return True

        except Exception as e:
            print(f"âŒ ç‚¹å‡»ç¡®è®¤æŒ‰é’®æ—¶å‡ºé”™: {e}")
            return False

    async def market_close_position(self, position_index=0):
        """
        å¸‚ä»·å¹³ä»“æŒ‡å®šæŒä»“
        position_index: æŒä»“ç´¢å¼•ï¼ˆ0è¡¨ç¤ºç¬¬ä¸€ä¸ªï¼‰
        """
        print("\n" + "=" * 60)
        print("ğŸ’° å¸‚ä»·å¹³ä»“")
        print("=" * 60)

        # è·å–æŒä»“åˆ—è¡¨
        positions = await self.get_position_list()

        if not positions:
            print("âŒ æ²¡æœ‰æ‰¾åˆ°æŒä»“")
            return False

        if position_index >= len(positions):
            print(f"âŒ æŒä»“ç´¢å¼• {position_index} è¶…å‡ºèŒƒå›´")
            return False

        position = positions[position_index]
        print(f"æ­£åœ¨å¹³ä»“: {position['product']} - æ•°é‡: {position['quantity']}")

        # 1. ç‚¹å‡» Market æŒ‰é’®æ‰“å¼€å¯¹è¯æ¡†
        if not await self.click_market_close_button(position['row_element']):
            return False

        # 2. å¸‚ä»·å¹³ä»“å¯¹è¯æ¡†ä¸­ï¼Œæ•°é‡å·²è‡ªåŠ¨å¡«å……ï¼Œç›´æ¥ç¡®è®¤å³å¯
        if not await self.confirm_close_position():
            return False

        print("âœ… å¸‚ä»·å¹³ä»“è®¢å•å·²æäº¤")
        await asyncio.sleep(2)

        return True

    async def limit_close_position(self, position_index=0, price=None):
        """
        é™ä»·å¹³ä»“æŒ‡å®šæŒä»“
        position_index: æŒä»“ç´¢å¼•ï¼ˆ0è¡¨ç¤ºç¬¬ä¸€ä¸ªï¼‰
        price: å¹³ä»“ä»·æ ¼ï¼ˆNoneè¡¨ç¤ºä½¿ç”¨ä¸­é—´ä»·ï¼‰
        """
        print("\n" + "=" * 60)
        print("ğŸ’° é™ä»·å¹³ä»“")
        print("=" * 60)

        # å¦‚æœæ²¡æœ‰æŒ‡å®šä»·æ ¼ï¼Œä½¿ç”¨ä¸­é—´ä»·
        if price is None:
            bid, ask = await self.get_order_book_prices()
            if bid and ask:
                price = self.calculate_mid_price(bid, ask)
            else:
                print("âŒ æ— æ³•è·å–ä»·æ ¼")
                return False

        # è·å–æŒä»“åˆ—è¡¨
        positions = await self.get_position_list()

        if not positions:
            print("âŒ æ²¡æœ‰æ‰¾åˆ°æŒä»“")
            return False

        if position_index >= len(positions):
            print(f"âŒ æŒä»“ç´¢å¼• {position_index} è¶…å‡ºèŒƒå›´")
            return False

        position = positions[position_index]
        print(f"æ­£åœ¨å¹³ä»“: {position['product']} - æ•°é‡: {position['quantity']}")

        # 1. ç‚¹å‡» Limit æŒ‰é’®æ‰“å¼€å¯¹è¯æ¡†
        if not await self.click_limit_close_button(position['row_element']):
            return False

        # 2. å¡«å†™ä»·æ ¼
        if not await self.fill_limit_close_form(price):
            return False

        # 3. ç¡®è®¤å¹³ä»“
        if not await self.confirm_close_position():
            return False

        print("âœ… é™ä»·å¹³ä»“è®¢å•å·²æäº¤")
        await asyncio.sleep(2)

        return True

    async def close_all_positions_market(self):
        """å¸‚ä»·å¹³ä»“æ‰€æœ‰æŒä»“"""
        print("\n" + "=" * 60)
        print("ğŸ’° å¸‚ä»·å¹³ä»“æ‰€æœ‰æŒä»“")
        print("=" * 60)

        # ç‚¹å‡» Close all positions æŒ‰é’®
        try:
            close_all_button = self.page.locator('button:has-text("Close all positions")')
            if await close_all_button.count() > 0:
                await close_all_button.click()
                await asyncio.sleep(1)

                # ç¡®è®¤å¯¹è¯æ¡†
                confirm_button = self.page.locator('button:has-text("Confirm")')
                if await confirm_button.count() > 0:
                    await confirm_button.click()
                    print("âœ… å·²æäº¤å¹³ä»“æ‰€æœ‰æŒä»“çš„è®¢å•")
                    await asyncio.sleep(2)
                    return True
            else:
                print("âš ï¸ æœªæ‰¾åˆ° Close all positions æŒ‰é’®")
                return False

        except Exception as e:
            print(f"âŒ å¹³ä»“æ‰€æœ‰æŒä»“æ—¶å‡ºé”™: {e}")
            return False

    # ==================== è®¢å•æŸ¥è¯¢ ====================

    async def check_open_orders(self, show_details=True):
        """æ£€æŸ¥æŒ‚å•"""
        try:
            if show_details:
                print("æ£€æŸ¥æŒ‚å•...")

            # ç‚¹å‡» Open orders æ ‡ç­¾
            open_orders_tab = self.page.locator('div:has-text("Open orders")').first
            await open_orders_tab.click()
            await asyncio.sleep(2)

            # æ£€æŸ¥æ˜¯å¦æœ‰æŒ‚å•
            no_results = self.page.locator('div:has-text("No results")')

            if await no_results.count() > 0:
                if show_details:
                    print("â„¹ï¸ å½“å‰æ²¡æœ‰æŒ‚å•")
                return 0
            else:
                # ä»æ ‡ç­¾æ–‡æœ¬ä¸­æå–æ•°é‡
                try:
                    tab_text = await open_orders_tab.text_content()
                    if '(' in tab_text and ')' in tab_text:
                        count_str = tab_text.split('(')[1].split(')')[0]
                        count = int(count_str)
                        if show_details:
                            print(f"âœ“ å½“å‰æœ‰ {count} ä¸ªæŒ‚å•")
                        return count
                    else:
                        if show_details:
                            print("âœ“ æ£€æµ‹åˆ°æŒ‚å•ä½†æ— æ³•è®¡æ•°")
                        return -1
                except:
                    if show_details:
                        print("âœ“ æ£€æµ‹åˆ°æŒ‚å•ä½†æ— æ³•è®¡æ•°")
                    return -1

        except Exception as e:
            print(f"âŒ æ£€æŸ¥æŒ‚å•æ—¶å‡ºé”™: {e}")
            return -1

    async def cancel_order(self, order_id: str = None, row_index: int = None) -> bool:
        """
        å–æ¶ˆå•ä¸ªè®¢å•

        Args:
            order_id: è®¢å•IDï¼ˆéƒ¨åˆ†åŒ¹é…å³å¯ï¼‰
            row_index: è®¢å•åœ¨è¡¨æ ¼ä¸­çš„è¡Œç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰

        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        try:
            print("\n" + "=" * 60)
            print(f"å¼€å§‹å–æ¶ˆè®¢å•: {order_id if order_id else f'ç¬¬{row_index + 1}è¡Œ'}")
            print("=" * 60)

            # åˆ‡æ¢åˆ°æœªç»“è®¢å•æ ‡ç­¾
            open_orders_tab = self.page.locator('div:has-text("Open orders")').first

            if await open_orders_tab.count() == 0:
                print("âœ— æœªæ‰¾åˆ°æœªç»“è®¢å•æ ‡ç­¾")
                return False

            # å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™ç‚¹å‡»
            if await open_orders_tab.get_attribute('aria-selected') != 'true':
                await open_orders_tab.click()
                await asyncio.sleep(1)
                print("âœ“ å·²åˆ‡æ¢åˆ°æœªç»“è®¢å•æ ‡ç­¾")

            # ç­‰å¾…è®¢å•é¢æ¿åŠ è½½
            orders_panel = self.page.locator(
                'div[role="tabpanel"][id*="open-orders"][data-state="active"]'
            ).first

            await expect(orders_panel).to_be_visible(timeout=5000)

            # æŸ¥æ‰¾è®¢å•è¡¨æ ¼è¡Œ
            table_rows = orders_panel.locator('div.style_tableRow__gbjWO')
            row_count = await table_rows.count()

            if row_count == 0:
                print("âœ— æœªç»“è®¢å•åˆ—è¡¨ä¸ºç©º")
                return False

            print(f"  æ‰¾åˆ° {row_count} ä¸ªæœªç»“è®¢å•")

            target_row = None

            # æ ¹æ®å‚æ•°æŸ¥æ‰¾ç›®æ ‡è®¢å•è¡Œ
            if row_index is not None:
                # æŒ‰è¡Œç´¢å¼•æŸ¥æ‰¾
                if row_index < row_count:
                    target_row = table_rows.nth(row_index)
                    print(f"âœ“ é€‰æ‹©ç¬¬ {row_index + 1} è¡Œè®¢å•")
                else:
                    print(f"âœ— ç´¢å¼• {row_index} è¶…å‡ºèŒƒå›´ï¼ˆå…± {row_count} è¡Œï¼‰")
                    return False

            elif order_id:
                # æŒ‰è®¢å•IDæŸ¥æ‰¾
                for i in range(row_count):
                    row = table_rows.nth(i)
                    # æŸ¥æ‰¾åŒ…å«è®¢å•IDçš„å•å…ƒæ ¼
                    order_id_cell = row.locator('.oneline-text').first

                    if await order_id_cell.count() > 0:
                        cell_text = await order_id_cell.text_content()
                        if order_id in cell_text:
                            target_row = row
                            print(f"âœ“ æ‰¾åˆ°è®¢å•IDåŒ¹é…çš„è®¢å•ï¼ˆç¬¬ {i + 1} è¡Œï¼‰")
                            break

                if target_row is None:
                    print(f"âœ— æœªæ‰¾åˆ°è®¢å•IDåŒ…å« '{order_id}' çš„è®¢å•")
                    return False
            else:
                print("âœ— å¿…é¡»æŒ‡å®š order_id æˆ– row_index")
                return False

            # åœ¨ç›®æ ‡è¡Œä¸­æŸ¥æ‰¾ Cancel æŒ‰é’®
            cancel_button = target_row.locator('button:has-text("Cancel")').last

            if await cancel_button.count() == 0:
                print("âœ— æœªæ‰¾åˆ° Cancel æŒ‰é’®")
                return False

            await expect(cancel_button).to_be_visible(timeout=5000)
            await expect(cancel_button).to_be_enabled(timeout=5000)

            # æ»šåŠ¨åˆ°æŒ‰é’®å¹¶ç‚¹å‡»
            await cancel_button.scroll_into_view_if_needed()
            await asyncio.sleep(0.3)

            await cancel_button.click()
            print("âœ“ å·²ç‚¹å‡» Cancel æŒ‰é’®")

            await asyncio.sleep(1)

            # éªŒè¯è®¢å•æ˜¯å¦å·²å–æ¶ˆï¼ˆæ£€æŸ¥è¡Œæ•°æ˜¯å¦å‡å°‘ï¼‰
            await asyncio.sleep(1)
            new_row_count = await table_rows.count()

            if new_row_count < row_count:
                print(f"âœ“ è®¢å•å·²å–æ¶ˆï¼ˆå‰©ä½™ {new_row_count} ä¸ªè®¢å•ï¼‰")
            else:
                print("âš ï¸  è®¢å•å¯èƒ½å·²å–æ¶ˆï¼ˆç­‰å¾…ç¡®è®¤ï¼‰")

            print("=" * 60)
            print("âœ… å–æ¶ˆè®¢å•æ“ä½œå®Œæˆ")
            print("=" * 60 + "\n")

            return True

        except Exception as e:
            print(f"âœ— å–æ¶ˆè®¢å•å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return False

    async def cancel_all_orders(self) -> bool:
        """
        å–æ¶ˆæ‰€æœ‰æœªç»“è®¢å•

        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        try:
            print("\n" + "=" * 60)
            print("å¼€å§‹å–æ¶ˆæ‰€æœ‰è®¢å•")
            print("=" * 60)

            # åˆ‡æ¢åˆ°æœªç»“è®¢å•æ ‡ç­¾
            open_orders_tab = self.page.locator(
                'button[role="tab"]:has-text("Open orders")'
            ).first

            if await open_orders_tab.count() == 0:
                print("âœ— æœªæ‰¾åˆ°æœªç»“è®¢å•æ ‡ç­¾")
                return False

            if await open_orders_tab.get_attribute('aria-selected') != 'true':
                await open_orders_tab.click()
                await asyncio.sleep(1)
                print("âœ“ å·²åˆ‡æ¢åˆ°æœªç»“è®¢å•æ ‡ç­¾")

            # ç­‰å¾…è®¢å•é¢æ¿åŠ è½½
            orders_panel = self.page.locator(
                'div[role="tabpanel"][id*="open-orders"][data-state="active"]'
            ).first

            await expect(orders_panel).to_be_visible(timeout=5000)

            # æŸ¥æ‰¾ "Cancel all orders" æŒ‰é’®
            cancel_all_button = self.page.locator(
                'button:has-text("Cancel all orders")'
            ).first

            if await cancel_all_button.count() == 0:
                print("âœ— æœªæ‰¾åˆ° Cancel all orders æŒ‰é’®")
                return False

            # æ£€æŸ¥æŒ‰é’®æ˜¯å¦å¯ç”¨
            if not await cancel_all_button.is_enabled():
                print("âš ï¸  Cancel all orders æŒ‰é’®ä¸å¯ç”¨ï¼ˆå¯èƒ½æ²¡æœ‰å¾…å–æ¶ˆçš„è®¢å•ï¼‰")
                return True

            await expect(cancel_all_button).to_be_visible(timeout=5000)
            await expect(cancel_all_button).to_be_enabled(timeout=5000)

            # è·å–å½“å‰è®¢å•æ•°é‡
            table_rows = orders_panel.locator('div.style_tableRow__gbjWO')
            initial_count = await table_rows.count()
            print(f"  å½“å‰æœ‰ {initial_count} ä¸ªæœªç»“è®¢å•")

            # ç‚¹å‡»æŒ‰é’®
            await cancel_all_button.scroll_into_view_if_needed()
            await asyncio.sleep(0.3)

            await cancel_all_button.click()
            print("âœ“ å·²ç‚¹å‡» Cancel all orders æŒ‰é’®")

            # å¯èƒ½ä¼šæœ‰ç¡®è®¤å¼¹çª—ï¼Œéœ€è¦å¤„ç†
            await asyncio.sleep(1)

            # æ£€æŸ¥æ˜¯å¦æœ‰ç¡®è®¤å¯¹è¯æ¡†
            confirm_dialog = self.page.locator('div[role="dialog"]').first
            if await confirm_dialog.count() > 0 and await confirm_dialog.is_visible():
                print("  æ£€æµ‹åˆ°ç¡®è®¤å¯¹è¯æ¡†")

                # æŸ¥æ‰¾ç¡®è®¤æŒ‰é’®ï¼ˆå¯èƒ½æ˜¯ "Confirm"ã€"Yes"ã€"ç¡®è®¤" ç­‰ï¼‰
                confirm_btn = confirm_dialog.locator(
                    'button:has-text("Confirm"), button:has-text("Yes"), button:has-text("ç¡®è®¤")'
                ).first

                if await confirm_btn.count() > 0:
                    await confirm_btn.click()
                    print("âœ“ å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®")
                    await asyncio.sleep(1)

            # ç­‰å¾…å¹¶éªŒè¯è®¢å•æ˜¯å¦å·²å…¨éƒ¨å–æ¶ˆ
            import time
            end_time = time.time() + 10

            while time.time() < end_time:
                current_count = await table_rows.count()

                if current_count == 0:
                    print("âœ“ æ‰€æœ‰è®¢å•å·²å–æ¶ˆ")
                    break

                print(f"  ç­‰å¾…è®¢å•å–æ¶ˆ... (å‰©ä½™ {current_count} ä¸ª)")
                await asyncio.sleep(1)
            else:
                final_count = await table_rows.count()
                if final_count < initial_count:
                    print(f"âœ“ éƒ¨åˆ†è®¢å•å·²å–æ¶ˆï¼ˆå‰©ä½™ {final_count} ä¸ªï¼‰")
                else:
                    print("âš ï¸  è®¢å•å–æ¶ˆçŠ¶æ€æœªç¡®è®¤")

            print("=" * 60)
            print("âœ… å–æ¶ˆæ‰€æœ‰è®¢å•æ“ä½œå®Œæˆ")
            print("=" * 60 + "\n")

            return True

        except Exception as e:
            print(f"âœ— å–æ¶ˆæ‰€æœ‰è®¢å•å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return False

    async def get_open_orders(self) -> list[dict]:
        """
        è·å–æ‰€æœ‰æœªç»“è®¢å•ä¿¡æ¯

        Returns:
            list: è®¢å•åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«è®¢å•è¯¦ç»†ä¿¡æ¯
        """
        try:
            print("\nè·å–æœªç»“è®¢å•...")

            # åˆ‡æ¢åˆ°æœªç»“è®¢å•æ ‡ç­¾
            open_orders_tab = self.page.locator(
                'button[role="tab"]:has-text("Open orders")'
            ).first

            if await open_orders_tab.count() == 0:
                print("âœ— æœªæ‰¾åˆ°æœªç»“è®¢å•æ ‡ç­¾")
                return []

            if await open_orders_tab.get_attribute('aria-selected') != 'true':
                await open_orders_tab.click()
                await asyncio.sleep(1)

            # ç­‰å¾…è®¢å•é¢æ¿åŠ è½½
            orders_panel = self.page.locator(
                'div[role="tabpanel"][id*="open-orders"][data-state="active"]'
            ).first

            await expect(orders_panel).to_be_visible(timeout=5000)

            # æŸ¥æ‰¾è®¢å•è¡¨æ ¼è¡Œ
            table_rows = orders_panel.locator('div.style_tableRow__gbjWO')
            row_count = await table_rows.count()

            if row_count == 0:
                print("âœ“ å½“å‰æ— æœªç»“è®¢å•")
                return []

            orders = []

            for i in range(row_count):
                try:
                    row = table_rows.nth(i)
                    cells = row.locator('div[data-sentry-component="Cell"]')

                    # è§£æè®¢å•ä¿¡æ¯
                    order = {
                        'row_index': i,
                        'product': await cells.nth(0).text_content() if await cells.count() > 0 else '',
                        'order_time': await cells.nth(1).text_content() if await cells.count() > 1 else '',
                        'direction': await cells.nth(2).text_content() if await cells.count() > 2 else '',
                        'order_price': await cells.nth(3).text_content() if await cells.count() > 3 else '',
                        'filled_unfilled': await cells.nth(5).text_content() if await cells.count() > 5 else '',
                        'order_type': await cells.nth(7).text_content() if await cells.count() > 7 else '',
                    }

                    # è·å–è®¢å•ID
                    order_id_cell = row.locator('.oneline-text').first
                    if await order_id_cell.count() > 0:
                        order['order_id'] = (await order_id_cell.text_content()).strip()
                    else:
                        order['order_id'] = ''

                    orders.append(order)

                    print(
                        f"  è®¢å• {i + 1}: {order['product']} | {order['direction']} | {order['order_price']} | {order['order_type']}")

                except Exception as e:
                    print(f"  è§£æç¬¬ {i + 1} è¡Œå¤±è´¥: {e}")
                    continue

            print(f"âœ“ å…±æ‰¾åˆ° {len(orders)} ä¸ªæœªç»“è®¢å•")
            return orders

        except Exception as e:
            print(f"âœ— è·å–æœªç»“è®¢å•å¤±è´¥: {e}")
            return []



    # ==================== æ­¢ç›ˆæ­¢æŸç›¸å…³ ====================

    async def get_position_liquidation_price(self, position_index: int = 0) -> Optional[float]:
        """
        è·å–æŒ‡å®šæŒä»“çš„æ¸…ç®—ä»·æ ¼

        Args:
            position_index: æŒä»“ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰

        Returns:
            float: æ¸…ç®—ä»·æ ¼ï¼Œè·å–å¤±è´¥è¿”å› None
        """
        try:
            print(f"\nè·å–æŒä»“ {position_index} çš„æ¸…ç®—ä»·æ ¼...")

            # åˆ‡æ¢åˆ° Positions æ ‡ç­¾
            positions_tab = self.page.locator('div:has-text("Positions")').first
            await positions_tab.click()
            await asyncio.sleep(1)

            # è·å–æŒä»“è¡Œ
            position_rows = self.page.locator(
                '[data-sentry-component="TablePositions"] .style_tableRow__gbjWO'
            )

            row_count = await position_rows.count()

            if row_count == 0:
                print("âœ— æ²¡æœ‰æ‰¾åˆ°æŒä»“")
                return None

            if position_index >= row_count:
                print(f"âœ— æŒä»“ç´¢å¼• {position_index} è¶…å‡ºèŒƒå›´ï¼ˆå…± {row_count} ä¸ªæŒä»“ï¼‰")
                return None

            # è·å–ç›®æ ‡æŒä»“è¡Œ
            target_row = position_rows.nth(position_index)

            # æŸ¥æ‰¾ Liq price åˆ—ï¼ˆç¬¬6åˆ—ï¼‰
            cells = target_row.locator('div[data-sentry-element="CellWrapper"]')

            if await cells.count() >= 6:
                liq_price_cell = cells.nth(5)  # Liq price åœ¨ç¬¬6åˆ—ï¼ˆç´¢å¼•5ï¼‰
                liq_price_text = await liq_price_cell.text_content()
                liq_price_text = liq_price_text.strip().replace(',', '')

                if liq_price_text and liq_price_text != '-':
                    liq_price = float(liq_price_text)
                    print(f"âœ“ æ¸…ç®—ä»·æ ¼: {liq_price}")
                    return liq_price

            print("âœ— æœªèƒ½è·å–æ¸…ç®—ä»·æ ¼")
            return None

        except Exception as e:
            print(f"âœ— è·å–æ¸…ç®—ä»·æ ¼å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return None

    async def click_edit_tpsl_button(self, position_index: int = 0) -> bool:
        """
        ç‚¹å‡»æŒ‡å®šæŒä»“çš„ç¼–è¾‘æ­¢ç›ˆæ­¢æŸæŒ‰é’®

        Args:
            position_index: æŒä»“ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰

        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        try:
            print(f"\nç‚¹å‡»æŒä»“ {position_index} çš„ç¼–è¾‘ TP/SL æŒ‰é’®...")

            # åˆ‡æ¢åˆ° Positions æ ‡ç­¾
            positions_tab = self.page.locator('div:has-text("Positions")').first
            await positions_tab.click()
            await asyncio.sleep(1)

            # è·å–æŒä»“è¡Œ
            position_rows = self.page.locator(
                '[data-sentry-component="TablePositions"] .style_tableRow__gbjWO'
            )

            row_count = await position_rows.count()

            if row_count == 0:
                print("âœ— æ²¡æœ‰æ‰¾åˆ°æŒä»“")
                return False

            if position_index >= row_count:
                print(f"âœ— æŒä»“ç´¢å¼• {position_index} è¶…å‡ºèŒƒå›´ï¼ˆå…± {row_count} ä¸ªæŒä»“ï¼‰")
                return False

            # è·å–ç›®æ ‡æŒä»“è¡Œ
            target_row = position_rows.nth(position_index)

            # æŸ¥æ‰¾ç¼–è¾‘æŒ‰é’®ï¼ˆé“…ç¬”å›¾æ ‡ï¼‰
            edit_button = target_row.locator(
                'span[data-sentry-element="IconEditLine"]'
            ).first

            if await edit_button.count() == 0:
                print("âœ— æœªæ‰¾åˆ°ç¼–è¾‘ TP/SL æŒ‰é’®")
                return False

            await edit_button.scroll_into_view_if_needed()
            await asyncio.sleep(0.3)
            await edit_button.click()
            print("âœ“ å·²ç‚¹å‡»ç¼–è¾‘ TP/SL æŒ‰é’®")
            await asyncio.sleep(1)

            # éªŒè¯å¯¹è¯æ¡†æ˜¯å¦æ‰“å¼€
            dialog = self.page.locator('.style_contentWrapper__JrKWn:has-text("Edit TP/SL")')

            if await dialog.count() > 0:
                print("âœ“ TP/SL ç¼–è¾‘å¯¹è¯æ¡†å·²æ‰“å¼€")
                return True
            else:
                print("âœ— TP/SL ç¼–è¾‘å¯¹è¯æ¡†æœªæ‰“å¼€")
                return False

        except Exception as e:
            print(f"âœ— ç‚¹å‡»ç¼–è¾‘ TP/SL æŒ‰é’®å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return False

    async def fill_tpsl_form(self, tp_roi: float = None, sl_roi: float = None) -> bool:
        """
        å¡«å†™æ­¢ç›ˆæ­¢æŸè¡¨å•ï¼ˆé€šè¿‡çˆ¶å…ƒç´ å’Œ ROI% æ–‡æœ¬å®šä½ï¼‰

        Args:
            tp_roi: æ­¢ç›ˆ ROI ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š50 è¡¨ç¤º 50%ï¼‰
            sl_roi: æ­¢æŸ ROI ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š-50 è¡¨ç¤º -50%ï¼‰

        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        try:
            print(f"\nå¡«å†™ TP/SL è¡¨å•...")
            if tp_roi is not None:
                print(f"  æ­¢ç›ˆ ROI: {tp_roi}%")
            if sl_roi is not None:
                print(f"  æ­¢æŸ ROI: {sl_roi}%")

            # ç­‰å¾…å¯¹è¯æ¡†åŠ è½½
            dialog = self.page.locator('.style_contentWrapper__JrKWn:has-text("Edit TP/SL")')
            await expect(dialog).to_be_visible(timeout=5000)
            await asyncio.sleep(1)

            # å¡«å†™æ­¢ç›ˆ (Take profit)
            if tp_roi is not None:
                print("  å¡«å†™æ­¢ç›ˆ ROI...")

                # æ–¹æ³•ï¼šæ‰¾åˆ°åŒ…å« "ROI%" æ–‡æœ¬çš„ Select ç»„ä»¶ï¼Œç„¶åæ‰¾å®ƒå‰é¢çš„ input
                # åœ¨ Take profit åŒºåŸŸ
                tp_section = dialog.locator('.fx-column.gap-3:has(div.heading-14:has-text("Take profit"))').first

                # æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ…å« ROI% çš„è¡Œ
                tp_roi_row = tp_section.locator('.fx.gap-2').first

                # åœ¨è¿™ä¸€è¡Œä¸­æ‰¾åˆ°ç¬¬äºŒä¸ªè¾“å…¥æ¡†å®¹å™¨ï¼ˆç¬¬ä¸€ä¸ªæ˜¯è§¦å‘ä»·æ ¼ï¼Œç¬¬äºŒä¸ªæ˜¯ ROI%ï¼‰
                tp_roi_container = tp_roi_row.locator('.text-field_textFieldContainer__qoENI').nth(1)

                # åœ¨å®¹å™¨ä¸­æ‰¾è¾“å…¥æ¡†
                tp_roi_input = tp_roi_container.locator('input').first

                # æ£€æŸ¥æ˜¯å¦å¯ç¼–è¾‘
                if await tp_roi_input.is_disabled():
                    print("âš ï¸ æ­¢ç›ˆ ROI è¾“å…¥æ¡†è¢«ç¦ç”¨ï¼Œå¯èƒ½éœ€è¦å…ˆå¡«å†™è§¦å‘ä»·æ ¼")
                    return False

                await tp_roi_input.scroll_into_view_if_needed()
                await asyncio.sleep(0.3)
                await tp_roi_input.click()
                await asyncio.sleep(0.2)
                await tp_roi_input.fill('')
                await asyncio.sleep(0.2)
                await tp_roi_input.fill(str(abs(tp_roi)))
                print(f"âœ“ å·²å¡«å…¥æ­¢ç›ˆ ROI: {tp_roi}%")
                await asyncio.sleep(0.5)

            # å¡«å†™æ­¢æŸ (Stop loss)
            if sl_roi is not None:
                print("  å¡«å†™æ­¢æŸ ROI...")

                # åœ¨ Stop loss åŒºåŸŸ
                sl_section = dialog.locator('.fx-column.gap-3:has(div.heading-14:has-text("Stop loss"))').first

                # æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ…å« ROI% çš„è¡Œ
                sl_roi_row = sl_section.locator('.fx.gap-2').first

                # åœ¨è¿™ä¸€è¡Œä¸­æ‰¾åˆ°ç¬¬äºŒä¸ªè¾“å…¥æ¡†å®¹å™¨
                sl_roi_container = sl_roi_row.locator('.text-field_textFieldContainer__qoENI').nth(1)

                # åœ¨å®¹å™¨ä¸­æ‰¾è¾“å…¥æ¡†
                sl_roi_input = sl_roi_container.locator('input').first

                # æ£€æŸ¥æ˜¯å¦å¯ç¼–è¾‘
                if await sl_roi_input.is_disabled():
                    print("âš ï¸ æ­¢æŸ ROI è¾“å…¥æ¡†è¢«ç¦ç”¨ï¼Œå¯èƒ½éœ€è¦å…ˆå¡«å†™è§¦å‘ä»·æ ¼")
                    return False

                await sl_roi_input.scroll_into_view_if_needed()
                await asyncio.sleep(0.3)
                await sl_roi_input.click()
                await asyncio.sleep(0.2)
                await sl_roi_input.fill('')
                await asyncio.sleep(0.2)
                await sl_roi_input.fill(str(sl_roi))
                print(f"âœ“ å·²å¡«å…¥æ­¢æŸ ROI: {sl_roi}%")
                await asyncio.sleep(0.5)

            return True

        except Exception as e:
            print(f"âœ— å¡«å†™ TP/SL è¡¨å•å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return False

    async def confirm_tpsl_edit(self) -> bool:
        """
        ç¡®è®¤ TP/SL ç¼–è¾‘ï¼ˆç¬¬ä¸€æ¬¡ç‚¹å‡» Confirmï¼‰

        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        try:
            print("\nç‚¹å‡» Confirm æŒ‰é’®...")

            # åœ¨ç¼–è¾‘å¯¹è¯æ¡†ä¸­æŸ¥æ‰¾ Confirm æŒ‰é’®
            dialog = self.page.locator('.style_contentWrapper__JrKWn:has-text("Edit TP/SL")')
            confirm_button = dialog.locator('button:has-text("Confirm")').last

            if await confirm_button.count() == 0:
                print("âœ— æœªæ‰¾åˆ° Confirm æŒ‰é’®")
                return False

            # æ£€æŸ¥æŒ‰é’®æ˜¯å¦å¯ç”¨
            if not await confirm_button.is_enabled():
                print("âœ— Confirm æŒ‰é’®ä¸å¯ç”¨ï¼ˆå¯èƒ½æœªå¡«å†™æœ‰æ•ˆæ•°æ®ï¼‰")
                return False

            await confirm_button.click()
            print("âœ“ å·²ç‚¹å‡» Confirm æŒ‰é’®")
            await asyncio.sleep(1)

            return True

        except Exception as e:
            print(f"âœ— ç‚¹å‡» Confirm æŒ‰é’®å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return False

    async def confirm_tpsl_final(self) -> bool:
        """
        æœ€ç»ˆç¡®è®¤ TP/SLï¼ˆç¬¬äºŒæ¬¡ç‚¹å‡» Confirmï¼‰

        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        try:
            print("\næœ€ç»ˆç¡®è®¤ TP/SL...")

            # ç­‰å¾…ç¡®è®¤å¯¹è¯æ¡†å‡ºç°
            confirm_dialog = self.page.locator(
                '.style_contentWrapper__JrKWn:has-text("Confirm Position TP/SL")'
            )

            await expect(confirm_dialog).to_be_visible(timeout=5000)
            print("âœ“ ç¡®è®¤å¯¹è¯æ¡†å·²æ‰“å¼€")

            # æŸ¥æ‰¾å¹¶ç‚¹å‡»æœ€ç»ˆçš„ Confirm æŒ‰é’®
            final_confirm_button = confirm_dialog.locator('button:has-text("Confirm")').last

            if await final_confirm_button.count() == 0:
                print("âœ— æœªæ‰¾åˆ°æœ€ç»ˆ Confirm æŒ‰é’®")
                return False

            await final_confirm_button.click()
            print("âœ“ å·²ç‚¹å‡»æœ€ç»ˆ Confirm æŒ‰é’®")
            await asyncio.sleep(2)

            # éªŒè¯å¯¹è¯æ¡†æ˜¯å¦å…³é—­
            if await confirm_dialog.count() == 0 or not await confirm_dialog.is_visible():
                print("âœ“ TP/SL è®¾ç½®æˆåŠŸ")
                return True
            else:
                print("âš ï¸ TP/SL è®¾ç½®çŠ¶æ€æœªç¡®è®¤")
                return True

        except Exception as e:
            print(f"âœ— æœ€ç»ˆç¡®è®¤ TP/SL å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return False


    async def set_position_tpsl(
            self,
            position_index: int = 0,
            tp_roi: float = None,
            sl_roi: float = None
    ) -> bool:
        """
        ä¸ºæŒ‡å®šæŒä»“è®¾ç½®æ­¢ç›ˆæ­¢æŸ

        Args:
            position_index: æŒä»“ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
            tp_roi: æ­¢ç›ˆ ROI ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š50 è¡¨ç¤º 50%ï¼‰
            sl_roi: æ­¢æŸ ROI ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š-50 è¡¨ç¤º -50%ï¼‰

        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        print("\n" + "=" * 60)
        print(f"âš™ï¸ è®¾ç½®æŒä»“ {position_index} çš„æ­¢ç›ˆæ­¢æŸ")
        print("=" * 60)

        try:
            # 1. è·å–æ¸…ç®—ä»·æ ¼ï¼ˆå¯é€‰ï¼Œç”¨äºéªŒè¯ï¼‰
            liq_price = await self.get_position_liquidation_price(position_index)

            if liq_price:
                print(f"  æŒä»“æ¸…ç®—ä»·æ ¼: {liq_price}")

            # 2. ç‚¹å‡»ç¼–è¾‘ TP/SL æŒ‰é’®
            if not await self.click_edit_tpsl_button(position_index):
                return False

            # 3. å¡«å†™æ­¢ç›ˆæ­¢æŸè¡¨å•
            if not await self.fill_tpsl_form(tp_roi, sl_roi):
                return False

            # 4. ç‚¹å‡»ç¬¬ä¸€ä¸ª Confirm
            if not await self.confirm_tpsl_edit():
                return False

            # 5. ç‚¹å‡»æœ€ç»ˆ Confirm
            if not await self.confirm_tpsl_final():
                return False

            print("=" * 60)
            print("âœ… æ­¢ç›ˆæ­¢æŸè®¾ç½®å®Œæˆ")
            print("=" * 60 + "\n")

            return True

        except Exception as e:
            print(f"âœ— è®¾ç½®æ­¢ç›ˆæ­¢æŸå¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return False

    async def set_all_positions_tpsl(
            self,
            tp_roi: float = None,
            sl_roi: float = None
    ) -> bool:
        """
        ä¸ºæ‰€æœ‰æŒä»“æ‰¹é‡è®¾ç½®æ­¢ç›ˆæ­¢æŸ

        Args:
            tp_roi: æ­¢ç›ˆ ROI ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š50 è¡¨ç¤º 50%ï¼‰
            sl_roi: æ­¢æŸ ROI ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š-50 è¡¨ç¤º -50%ï¼‰

        Returns:
            bool: æ“ä½œæ˜¯å¦æˆåŠŸ
        """
        print("\n" + "=" * 60)
        print("âš™ï¸ æ‰¹é‡è®¾ç½®æ‰€æœ‰æŒä»“çš„æ­¢ç›ˆæ­¢æŸ")
        print("=" * 60)

        try:
            # è·å–æŒä»“æ•°é‡
            position_count = await self.check_positions(show_details=False)

            if position_count <= 0:
                print("âœ— æ²¡æœ‰æŒä»“éœ€è¦è®¾ç½®")
                return False

            print(f"  å…±æœ‰ {position_count} ä¸ªæŒä»“")

            success_count = 0

            # ä¸ºæ¯ä¸ªæŒä»“è®¾ç½®æ­¢ç›ˆæ­¢æŸ
            for i in range(position_count):
                print(f"\nå¤„ç†æŒä»“ {i + 1}/{position_count}...")

                if await self.set_position_tpsl(i, tp_roi, sl_roi):
                    success_count += 1
                    print(f"âœ“ æŒä»“ {i + 1} è®¾ç½®æˆåŠŸ")
                else:
                    print(f"âœ— æŒä»“ {i + 1} è®¾ç½®å¤±è´¥")

                # ç­‰å¾…ä¸€ä¸‹å†å¤„ç†ä¸‹ä¸€ä¸ª
                await asyncio.sleep(1)

            print("\n" + "=" * 60)
            print(f"âœ… æ‰¹é‡è®¾ç½®å®Œæˆ: {success_count}/{position_count} æˆåŠŸ")
            print("=" * 60 + "\n")

            return success_count == position_count

        except Exception as e:
            print(f"âœ— æ‰¹é‡è®¾ç½®æ­¢ç›ˆæ­¢æŸå¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            return False
